# steps:
#   # Step 1:  Build Docker image
#   - name: 'gcr.io/cloud-builders/docker'
#     args:
#       [
#         'build',
#         '-t', 'us-west1-docker.pkg.dev/$PROJECT_ID/my-repo/mayaworld13:$COMMIT_SHA',
#         '.'
#       ]

#   # Step 2: Push Docker image to Artifact Registry
#   - name: 'gcr.io/cloud-builders/docker'
#     args:
#       [
#         'push',
#         'us-west1-docker.pkg.dev/$PROJECT_ID/my-repo/mayaworld13:$COMMIT_SHA'
#       ]

#   # Step 3: Deploy to Cloud Run
#   - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
#     entrypoint: gcloud
#     args:
#       [
#         'run', 'deploy', 'mayaworld13',
#         '--image', 'us-west1-docker.pkg.dev/$PROJECT_ID/my-repo/mayaworld13:$COMMIT_SHA',
#         '--region', 'us-west1',
#         '--platform', 'managed',
#         '--allow-unauthenticated',
#         '--port', '5000'
#       ]
#   - name: 'gcr.io/cloud-builders/gcloud'
#     args:
#       [
#          'container', 'clusters', 'get-credentials', 'autopilot-cluster-1',
#          '--region', 'us-west1',
#          '--project', '$PROJECT_ID'
#       ]

#   # Step 4: Deploy to GKE
#   - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:latest'
#     entrypoint: 'bash'
#     args:
#       - '-c'
#       - |
#         echo "Deploying app..."
#         kubectl apply -f deployment.yaml
#         echo "Updating image tag dynamically..."
#         kubectl set image deployment/mayaworld13 \
#           mayaworld13=us-west1-docker.pkg.dev/$PROJECT_ID/my-repo/mayaworld13:$COMMIT_SHA \
#           --namespace=default

# images:
#   - 'us-west1-docker.pkg.dev/$PROJECT_ID/my-repo/mayaworld13:$COMMIT_SHA'

# #  Fix for logging / service account error
# options:
#   logging: CLOUD_LOGGING_ONLY



steps:
  # 1️⃣ Build Docker image
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'us-west1-docker.pkg.dev/$PROJECT_ID/my-repo/mayaworld13:$SHORT_SHA', '.']

  # 2️⃣ Push image to Artifact Registry
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'us-west1-docker.pkg.dev/$PROJECT_ID/my-repo/mayaworld13:$SHORT_SHA']

  # 3️⃣ Update image tag in deployment.yaml and push to GitHub
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: bash
    args:
      - -c
      - |
        sed -i "s#image: .*#image: us-west1-docker.pkg.dev/$PROJECT_ID/my-repo/mayaworld13:$SHORT_SHA#g" deployment.yaml
        git config --global user.email "cloudbuild@google.com"
        git config --global user.name "Cloud Build"
        git add deployment.yaml
        git commit -m "Auto-update image tag to $SHORT_SHA"
        git push https://mayaworld13:$(gcloud secrets versions access latest --secret=GITHUB_TOKEN)@github.com/mayaworld13/python-gcp.git HEAD:main

images:
  - 'us-west1-docker.pkg.dev/$PROJECT_ID/my-repo/mayaworld13:$SHORT_SHA'

options:
  logging: CLOUD_LOGGING_ONLY

